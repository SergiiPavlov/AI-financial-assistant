<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>AI Financial Assistant Demo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  section { margin-bottom: 24px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
  label { display: block; margin: 6px 0 2px; }
  textarea, input, select { width: 100%; padding: 6px; }
  button { margin-top: 8px; padding: 8px 12px; cursor: pointer; }
  pre { background: #f5f5f5; padding: 8px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
  th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; }
  th { background: #f0f0f0; }
  .muted { color: #666; font-size: 12px; }
  #summaryTables { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 8px; }
  .quick-ranges { margin-top: 6px; display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 13px; }
  .quick-ranges span { font-weight: 500; }
  .quick-examples { margin-top: 6px; display: flex; flex-direction: column; gap: 4px; font-size: 13px; }
  .quick-examples-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
  .quick-examples button, .quick-ranges button { padding: 4px 8px; font-size: 12px; cursor: pointer; }
  .quick-examples-label { font-size: 12px; }
  .assistant-human { margin-top: 8px; padding: 8px; border-radius: 6px; background: #eef9ff; font-size: 14px; line-height: 1.4; white-space: pre-wrap; }
  .drill-row { cursor: pointer; }
  .drill-row:hover { background: #f7fbff; }
  .inline { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
</style>
</head>
<body>
  <section id="uiLangSection">
    <label data-i18n="ui_lang_label" for="uiLangSelect">Язык интерфейса:</label>
    <select id="uiLangSelect">
      <option value="ru">Русский</option>
      <option value="uk">Українська</option>
      <option value="en">English</option>
    </select>
  </section>

  <h1 data-i18n="title">AI Financial Assistant</h1>

  <section id="authSection">
    <h2 data-i18n="section_auth">Авторизация</h2>
    <label data-i18n="label_email">Email (опционально)</label>
    <input id="emailInput" placeholder="demo_user@example.com" />
    <div class="inline">
      <button id="loginBtn" data-i18n="btn_login" onclick="login()">Login</button>
      <button id="logoutBtn" data-i18n="btn_logout" onclick="logout()" disabled>Logout</button>
      <span id="currentUser" class="muted" data-i18n="label_current_user">Current user: not logged in</span>
    </div>
  </section>

  <section>
    <h2 data-i18n="section_parse_text">Парсинг текста</h2>
    <label data-i18n="label_text">Текст</label>
    <textarea id="text" rows="3">Сегодня 300 на продукты и 200 на такси</textarea>
    <button data-i18n="btn_send_parse_text" onclick="parseText()">Отправить /parse-text</button>
    <pre id="parseResult"></pre>
    <div class="muted" id="parseWarningsBlock" style="display:none;"><strong data-i18n="parse_warnings_title">Предупреждения</strong><ul id="parseWarningsList"></ul></div>
    <div class="muted" id="parseQuestionsBlock" style="display:none;"><strong data-i18n="parse_questions_title">Вопросы для уточнения</strong><ul id="parseQuestionsList"></ul></div>
    <button data-i18n="btn_create_draft" id="saveParsedBtn" onclick="createDraftFromParsed()">Создать черновик</button>
  </section>

  <section>
    <h2 data-i18n="section_voice">Голосовой ввод (файл)</h2>
    <p class="muted">Шаг 1: выберите аудиофайл (webm/wav/m4a и т.п.), шаг 2: отправьте на /voice, затем сохраните как черновик и примените.</p>
    <label data-i18n="label_voice_file">Аудиофайл</label>
    <input accept="audio/*" id="voiceFile" type="file"/>
    <button data-i18n="btn_send_voice" onclick="parseVoice()">Отправить /voice</button>
    <pre id="voiceResult"></pre>
  </section>

  <section>
    <h2 data-i18n="section_drafts">Черновики</h2>
    <div class="inline">
      <button data-i18n="btn_load_drafts" type="button" onclick="loadDrafts()">Загрузить черновики</button>
      <span class="muted" data-i18n="drafts_hint">Черновики можно редактировать и применить в транзакции.</span>
    </div>
    <div id="draftsList"></div>
    <div id="draftDetails"></div>
  </section>

  <section>
    <h2 data-i18n="section_transactions">Транзакции</h2>
    <div class="inline">
      <label for="txCategoryFilter" data-i18n="label_tx_category">Фильтр по категории</label>
      <select id="txCategoryFilter">
        <option value="" data-i18n="tx_category_all">Все категории</option>
      </select>
      <label for="txTypeFilter" data-i18n="label_tx_type">Тип транзакции</label>
      <select id="txTypeFilter">
        <option value="all" data-i18n="tx_type_all">Все</option>
        <option value="expense" data-i18n="tx_type_expense">Расходы</option>
        <option value="income" data-i18n="tx_type_income">Доходы</option>
      </select>
      <label for="txLimit" data-i18n="label_limit">Лимит</label>
      <input id="txLimit" type="number" value="50" min="1" max="200" style="width:90px" />
    </div>
    <div id="txFiltersInfo" class="muted"></div>
    <div class="inline">
      <button data-i18n="btn_load_transactions" onclick="loadTransactions()">Загрузить /transactions</button>
      <button data-i18n="btn_export_csv" type="button" onclick="exportTransactionsCsv()">Экспорт CSV</button>
    </div>
    <pre id="transactions"></pre>
    <div class="muted" data-i18n="quick_table_hint">Таблица для быстрого просмотра:</div>
    <table id="transactionsTable">
      <thead>
        <tr>
          <th data-i18n="col_date">Дата</th>
          <th data-i18n="col_category">Категория</th>
          <th data-i18n="col_type">Тип</th>
          <th data-i18n="col_amount">Сумма</th>
          <th data-i18n="col_currency">Валюта</th>
          <th data-i18n="col_description">Описание</th>
          <th data-i18n="col_source">Источник</th>
          <th data-i18n="col_actions">Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h2 data-i18n="section_summary">Сводка</h2>
    <label data-i18n="label_from">From</label>
    <input id="summaryFrom" placeholder="2025-12-01"/>
    <label data-i18n="label_to">To</label>
    <input id="summaryTo" placeholder="2025-12-31"/>
    <div class="quick-ranges">
      <span data-i18n="summary_quick">Быстрые периоды:</span>
      <button type="button" onclick="setSummaryRange('today')" data-i18n="summary_today">Сегодня</button>
      <button type="button" onclick="setSummaryRange('week')" data-i18n="summary_week">Эта неделя</button>
      <button type="button" onclick="setSummaryRange('month')" data-i18n="summary_month">Этот месяц</button>
    </div>
    <button data-i18n="btn_get_summary" onclick="getSummary()">Получить summary</button>
    <div id="summaryTotals" class="inline" style="gap: 12px; font-weight: 600;"></div>
    <pre id="summary"></pre>
    <div class="muted" data-i18n="summary_hint">Сводка по категориям и датам:</div>
    <div class="muted" data-i18n="summary_drill_hint">Можно кликать по категориям и датам, чтобы фильтровать таблицу.</div>
    <div id="summaryTables">
      <table id="summaryByCategory">
        <thead>
          <tr>
            <th data-i18n="col_category">Категория</th>
            <th data-i18n="col_amount">Сумма</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <table id="summaryByDate">
        <thead>
          <tr>
            <th data-i18n="col_date">Дата</th>
            <th data-i18n="col_amount">Сумма</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section>
    <h2 data-i18n="section_assistant">Вопрос ассистенту</h2>
    <label data-i18n="label_assistant_msg">Сообщение</label>
    <textarea id="assistantMsg" rows="2">Сколько потратил на еду в этом месяце?</textarea>
    <div id="assistantExamples" class="quick-examples"></div>
    <button data-i18n="btn_ask_assistant" onclick="askAssistant()">Спросить</button>
    <div id="assistantHuman" class="assistant-human"></div>
    <pre id="assistant"></pre>
  </section>

<script>
  let currentUiLang = 'ru';
  let accessToken = localStorage.getItem('demoAccessToken') || '';
  let currentUser = null;
  let lastParse = null;
  let lastParseSource = 'manual';
  let lastDraftId = null;
  let lastLoadedTransactions = [];
  let lastSummaryData = null;
  let draftList = [];
  let currentDraft = null;
  let draftEditItems = [];
  let draftEditTitle = '';
  let categoriesMeta = [];
  let categoryLabelById = {};
  const activeTxFilters = { from: '', to: '', category: '', type: 'all', page: 1, limit: 50 };

  const UI_TEXT = {
    ru: {
      ui_lang_label: 'Язык интерфейса:',
      title: 'AI Financial Assistant',
      section_auth: 'Авторизация',
      section_parse_text: 'Парсинг текста',
      section_voice: 'Голосовой ввод (файл)',
      section_drafts: 'Черновики',
      section_transactions: 'Транзакции',
      section_summary: 'Сводка',
      section_assistant: 'Вопрос ассистенту',
      label_email: 'Email (опционально)',
      label_current_user: 'Текущий пользователь:',
      label_not_logged_in: 'не залогинен',
      label_text: 'Текст',
      label_voice_file: 'Аудиофайл',
      label_from: 'From',
      label_to: 'To',
      label_assistant_msg: 'Сообщение',
      label_tx_category: 'Фильтр по категории',
      label_tx_type: 'Тип транзакции',
      label_limit: 'Лимит',
      tx_category_all: 'Все категории',
      tx_type_all: 'Все',
      tx_type_expense: 'Расходы',
      tx_type_income: 'Доходы',
      btn_login: 'Login',
      btn_logout: 'Logout',
      btn_send_parse_text: 'Отправить /parse-text',
      btn_create_draft: 'Создать черновик',
      btn_draft_created: 'Черновик сохранен',
      btn_save_draft: 'Сохранить черновик',
      btn_apply_draft: 'Применить',
      btn_discard_draft: 'Удалить/Discard',
      btn_load_drafts: 'Загрузить черновики',
      btn_open: 'Открыть',
      btn_send_voice: 'Отправить /voice',
      btn_load_transactions: 'Загрузить /transactions',
      btn_export_csv: 'Экспорт CSV',
      btn_get_summary: 'Получить summary',
      btn_ask_assistant: 'Спросить',
      summary_hint: 'Сводка по категориям и датам:',
      summary_drill_hint: 'Можно кликать по категориям и датам, чтобы фильтровать таблицу транзакций.',
      summary_income: 'Доходы',
      summary_expense: 'Расходы',
      summary_balance: 'Баланс',
      col_date: 'Дата',
      col_category: 'Категория',
      col_type: 'Тип',
      col_amount: 'Сумма',
      col_currency: 'Валюта',
      col_description: 'Описание',
      col_source: 'Источник',
      quick_table_hint: 'Таблица для быстрого просмотра:',
      parse_warnings_title: 'Предупреждения',
      parse_questions_title: 'Вопросы для уточнения',
      msg_select_file_first: 'Сначала выберите аудиофайл.',
      msg_parse_text_first: 'Сначала распарсьте текст',
      msg_already_saved: 'Эти транзакции уже сохранены',
      msg_no_transactions: 'Транзакций нет',
      msg_no_category: '(без категории)',
      msg_no_data: 'Нет данных',
      msg_export_period_required: 'Сначала задайте from/to в блоке «Сводка».',
      msg_export_failed: 'Не удалось экспортировать CSV.',
      col_actions: 'Действия',
      btn_edit: 'Правка',
      btn_delete: 'Удалить',
      confirm_delete: 'Удалить эту транзакцию?',
      prompt_edit_amount: 'Новая сумма:',
      prompt_edit_category: 'Новая категория:',
      prompt_edit_description: 'Новое описание:',
      msg_invalid_amount: 'Сумма должна быть положительным числом.',
      msg_login_required: 'Сначала выполните вход.',
      label_active_filters: 'Активные фильтры:',
      filters_none: 'нет',
      filter_category: 'категория',
      filter_type: 'тип',
      filter_from: 'from',
      filter_to: 'to',
      summary_quick: 'Быстрые периоды:',
      summary_today: 'Сегодня',
      summary_week: 'Эта неделя',
      summary_month: 'Этот месяц',
      drafts_hint: 'Черновики можно редактировать и применить в транзакции.',
      col_title: 'Заголовок',
      col_status: 'Статус',
      col_items: 'Строк',
      col_created: 'Создано',
      draft_status_draft: 'Черновик',
      draft_status_applied: 'Применено',
      draft_status_discarded: 'Удалено',
      draft_source_voice: 'голос',
      draft_source_text: 'текст',
      draft_source_manual: 'вручную',
      draft_title_prefix: 'Черновик от',
      msg_failed_create_draft: 'Не удалось создать черновик',
      msg_failed_load_drafts: 'Не удалось загрузить черновики',
      msg_failed_save_draft: 'Не удалось сохранить черновик',
      msg_draft_saved: 'Черновик сохранен',
      msg_failed_apply_draft: 'Не удалось применить черновик',
      msg_apply_duplicate: 'Черновик уже применен, операции не дублируются',
      msg_draft_applied: 'Черновик применен',
      msg_failed_discard_draft: 'Не удалось удалить черновик',
      msg_draft_discarded: 'Черновик помечен как удаленный',
      msg_no_drafts: 'Черновиков пока нет',
      msg_no_title: '(без названия)',
      msg_select_draft: 'Выберите черновик для просмотра',
      msg_no_items: 'Нет строк',
      label_draft_title: 'Название черновика',
      label_draft_status: 'Статус'
    },
    uk: {
      ui_lang_label: 'Мова інтерфейсу:',
      title: 'Голосовий фінансовий асистент',
      section_auth: 'Авторизація',
      section_parse_text: 'Парсинг тексту',
      section_voice: 'Голосове введення (файл)',
      section_drafts: 'Чернетки',
      section_transactions: 'Транзакції',
      section_summary: 'Підсумок',
      section_assistant: 'Питання асистенту',
      label_email: 'Email (опційно)',
      label_current_user: 'Поточний користувач:',
      label_not_logged_in: 'не залогінений',
      label_text: 'Текст',
      label_voice_file: 'Аудіофайл',
      label_from: 'З',
      label_to: 'По',
      label_assistant_msg: 'Повідомлення',
      label_tx_category: 'Фільтр за категорією',
      label_tx_type: 'Тип транзакції',
      label_limit: 'Ліміт',
      tx_category_all: 'Усі категорії',
      tx_type_all: 'Усі',
      tx_type_expense: 'Витрати',
      tx_type_income: 'Дохід',
      btn_login: 'Login',
      btn_logout: 'Logout',
      btn_send_parse_text: 'Надіслати /parse-text',
      btn_create_draft: 'Створити чернетку',
      btn_draft_created: 'Чернетку збережено',
      btn_save_draft: 'Зберегти чернетку',
      btn_apply_draft: 'Застосувати',
      btn_discard_draft: 'Видалити/Discard',
      btn_load_drafts: 'Завантажити чернетки',
      btn_open: 'Відкрити',
      btn_send_voice: 'Надіслати /voice',
      btn_load_transactions: 'Завантажити /transactions',
      btn_export_csv: 'Експорт CSV',
      btn_get_summary: 'Отримати summary',
      btn_ask_assistant: 'Спитати',
      summary_hint: 'Підсумок за категоріями та датами:',
      summary_drill_hint: 'Можна клікати по категоріях і датах, щоб фільтрувати таблицю транзакцій.',
      summary_income: 'Дохід',
      summary_expense: 'Витрати',
      summary_balance: 'Баланс',
      col_date: 'Дата',
      col_category: 'Категорія',
      col_type: 'Тип',
      col_amount: 'Сума',
      col_currency: 'Валюта',
      col_description: 'Опис',
      col_source: 'Джерело',
      quick_table_hint: 'Таблиця для швидкого перегляду:',
      parse_warnings_title: 'Попередження',
      parse_questions_title: 'Питання для уточнення',
      msg_select_file_first: 'Спочатку виберіть аудіофайл.',
      msg_parse_text_first: 'Спочатку розберіть текст.',
      msg_already_saved: 'Ці транзакції вже збережені.',
      msg_no_transactions: 'Транзакцій немає',
      msg_no_category: '(без категорії)',
      msg_no_data: 'Немає даних',
      msg_export_period_required: 'Спочатку вкажіть from/to у блоці «Підсумок».',
      msg_export_failed: 'Не вдалося експортувати CSV.',
      col_actions: 'Дії',
      btn_edit: 'Редагувати',
      btn_delete: 'Видалити',
      confirm_delete: 'Видалити цю транзакцію?',
      prompt_edit_amount: 'Нова сума:',
      prompt_edit_category: 'Нова категорія:',
      prompt_edit_description: 'Новий опис:',
      msg_invalid_amount: 'Сума має бути додатнім числом.',
      msg_login_required: 'Спочатку виконайте вхід.',
      label_active_filters: 'Активні фільтри:',
      filters_none: 'немає',
      filter_category: 'категорія',
      filter_type: 'тип',
      filter_from: 'з',
      filter_to: 'по',
      summary_quick: 'Швидкі періоди:',
      summary_today: 'Сьогодні',
      summary_week: 'Цей тиждень',
      summary_month: 'Цей місяць',
      drafts_hint: 'Чернетки можна редагувати і застосувати до транзакцій.',
      col_title: 'Заголовок',
      col_status: 'Статус',
      col_items: 'Рядків',
      col_created: 'Створено',
      draft_status_draft: 'Чернетка',
      draft_status_applied: 'Застосовано',
      draft_status_discarded: 'Видалено',
      draft_source_voice: 'голос',
      draft_source_text: 'текст',
      draft_source_manual: 'вручну',
      draft_title_prefix: 'Чернетка від',
      msg_failed_create_draft: 'Не вдалося створити чернетку',
      msg_failed_load_drafts: 'Не вдалося завантажити чернетки',
      msg_failed_save_draft: 'Не вдалося зберегти чернетку',
      msg_draft_saved: 'Чернетку збережено',
      msg_failed_apply_draft: 'Не вдалося застосувати чернетку',
      msg_apply_duplicate: 'Чернетка вже застосована, дублювання немає',
      msg_draft_applied: 'Чернетку застосовано',
      msg_failed_discard_draft: 'Не вдалося видалити чернетку',
      msg_draft_discarded: 'Чернетку позначено як видалену',
      msg_no_drafts: 'Чернеток поки немає',
      msg_no_title: '(без назви)',
      msg_select_draft: 'Оберіть чернетку для перегляду',
      msg_no_items: 'Немає рядків',
      label_draft_title: 'Назва чернетки',
      label_draft_status: 'Статус'
    },
    en: {
      ui_lang_label: 'Interface language:',
      title: 'AI Financial Assistant',
      section_auth: 'Authentication',
      section_parse_text: 'Text parsing',
      section_voice: 'Voice input (file)',
      section_drafts: 'Drafts',
      section_transactions: 'Transactions',
      section_summary: 'Summary',
      section_assistant: 'Ask the assistant',
      label_email: 'Email (optional)',
      label_current_user: 'Current user:',
      label_not_logged_in: 'not logged in',
      label_text: 'Text',
      label_voice_file: 'Audio file',
      label_from: 'From',
      label_to: 'To',
      label_assistant_msg: 'Message',
      label_tx_category: 'Category filter',
      label_tx_type: 'Transaction type',
      label_limit: 'Limit',
      tx_category_all: 'All categories',
      tx_type_all: 'All',
      tx_type_expense: 'Expenses',
      tx_type_income: 'Income',
      btn_login: 'Login',
      btn_logout: 'Logout',
      btn_send_parse_text: 'Send /parse-text',
      btn_create_draft: 'Create draft',
      btn_draft_created: 'Draft saved',
      btn_save_draft: 'Save draft',
      btn_apply_draft: 'Apply',
      btn_discard_draft: 'Discard',
      btn_load_drafts: 'Load drafts',
      btn_open: 'Open',
      btn_send_voice: 'Send /voice',
      btn_load_transactions: 'Load /transactions',
      btn_export_csv: 'Export CSV',
      btn_get_summary: 'Get summary',
      btn_ask_assistant: 'Ask',
      summary_hint: 'Summary by categories and dates:',
      summary_drill_hint: 'Click categories or dates to filter the transactions table.',
      summary_income: 'Income',
      summary_expense: 'Expenses',
      summary_balance: 'Balance',
      col_date: 'Date',
      col_category: 'Category',
      col_type: 'Type',
      col_amount: 'Amount',
      col_currency: 'Currency',
      col_description: 'Description',
      col_source: 'Source',
      quick_table_hint: 'Quick table:',
      parse_warnings_title: 'Warnings',
      parse_questions_title: 'Clarifying questions',
      msg_select_file_first: 'Select an audio file first.',
      msg_parse_text_first: 'Parse the text first.',
      msg_already_saved: 'These transactions are already saved.',
      msg_no_transactions: 'No transactions',
      msg_no_category: '(no category)',
      msg_no_data: 'No data',
      msg_export_period_required: 'Set from/to in the Summary section first.',
      msg_export_failed: 'Failed to export CSV.',
      col_actions: 'Actions',
      btn_edit: 'Edit',
      btn_delete: 'Delete',
      confirm_delete: 'Delete this transaction?',
      prompt_edit_amount: 'New amount:',
      prompt_edit_category: 'New category:',
      prompt_edit_description: 'New description:',
      msg_invalid_amount: 'Amount must be a positive number.',
      msg_login_required: 'Please login first.',
      label_active_filters: 'Active filters:',
      filters_none: 'none',
      filter_category: 'category',
      filter_type: 'type',
      filter_from: 'from',
      filter_to: 'to',
      summary_quick: 'Quick ranges:',
      summary_today: 'Today',
      summary_week: 'This week',
      summary_month: 'This month',
      drafts_hint: 'Drafts can be edited and applied to transactions.',
      col_title: 'Title',
      col_status: 'Status',
      col_items: 'Items',
      col_created: 'Created',
      draft_status_draft: 'Draft',
      draft_status_applied: 'Applied',
      draft_status_discarded: 'Discarded',
      draft_source_voice: 'voice',
      draft_source_text: 'text',
      draft_source_manual: 'manual',
      draft_title_prefix: 'Draft from',
      msg_failed_create_draft: 'Failed to create draft',
      msg_failed_load_drafts: 'Failed to load drafts',
      msg_failed_save_draft: 'Failed to save draft',
      msg_draft_saved: 'Draft saved',
      msg_failed_apply_draft: 'Failed to apply draft',
      msg_apply_duplicate: 'Draft already applied, no duplicates',
      msg_draft_applied: 'Draft applied',
      msg_failed_discard_draft: 'Failed to discard draft',
      msg_draft_discarded: 'Draft marked as discarded',
      msg_no_drafts: 'No drafts yet',
      msg_no_title: '(no title)',
      msg_select_draft: 'Open a draft to view details',
      msg_no_items: 'No rows',
      label_draft_title: 'Draft title',
      label_draft_status: 'Status'
    }
  };

  function t(key) {
    const lang = UI_TEXT[currentUiLang] ? currentUiLang : 'ru';
    return (UI_TEXT[lang] && UI_TEXT[lang][key]) || (UI_TEXT['ru'] && UI_TEXT['ru'][key]) || key;
  }

  function applyUiLang() {
    const lang = UI_TEXT[currentUiLang] ? currentUiLang : 'ru';
    const map = UI_TEXT[lang] || UI_TEXT['ru'];
    const langLabel = document.querySelector('label[for="uiLangSelect"][data-i18n="ui_lang_label"]');
    if (langLabel && map.ui_lang_label) {
      langLabel.textContent = map.ui_lang_label;
    }
    Object.keys(map).forEach((key) => {
      const nodes = document.querySelectorAll('[data-i18n="' + key + '"]');
      nodes.forEach((el) => {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.setAttribute('placeholder', map[key]);
        } else {
          el.textContent = map[key];
        }
      });
    });
    renderAssistantExamples();
    updateTransactionsFilterInfo();
  }

  const langSelect = document.getElementById('uiLangSelect');
  if (langSelect) {
    langSelect.addEventListener('change', (e) => {
      currentUiLang = e.target.value;
      applyUiLang();
      loadCategoriesForLang(currentUiLang);
      renderTransactionsTable(lastLoadedTransactions);
      if (lastSummaryData) {
        renderSummaryTables(lastSummaryData);
      }
    });
  }

  function setCategoriesMeta(meta) {
    categoriesMeta = Array.isArray(meta) ? meta : [];
    categoryLabelById = Object.fromEntries(categoriesMeta.map((c) => [c.id, c.label]));
    renderCategoryFilterOptions();
    renderTransactionsTable(lastLoadedTransactions);
    if (lastSummaryData) {
      renderSummaryTables(lastSummaryData);
    }
    updateTransactionsFilterInfo();
  }

  async function loadCategoriesForLang(lang) {
    try {
      const res = await fetch(`/api/finance/meta/categories?lang=${encodeURIComponent(lang || 'ru')}`);
      if (!res.ok) {
        throw new Error('Failed to load categories');
      }
      const data = await res.json();
      setCategoriesMeta(data);
    } catch (e) {
      console.error(e);
      setCategoriesMeta([]);
    }
  }

  function getCategoryLabelForUi(id) {
    if (!id) return t('msg_no_category');
    return categoryLabelById[id] || t('msg_no_category');
  }

  function getCategoryIdByLabel(label) {
    if (!label) return '';
    const normalized = label.trim().toLowerCase();
    const found = categoriesMeta.find(
      (c) => c.id.toLowerCase() === normalized || c.label.toLowerCase() === normalized
    );
    return found ? found.id : '';
  }

  function setAccessToken(token) {
    accessToken = token || '';
    if (accessToken) {
      localStorage.setItem('demoAccessToken', accessToken);
    } else {
      localStorage.removeItem('demoAccessToken');
    }
  }

  function updateAuthUi() {
    const userLabel = document.getElementById('currentUser');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    if (userLabel) {
      if (currentUser) {
        userLabel.textContent = `${t('label_current_user')} ${currentUser.email || currentUser.id}`;
      } else {
        userLabel.textContent = `${t('label_current_user')} ${t('label_not_logged_in')}`;
      }
    }
    if (logoutBtn) logoutBtn.disabled = !currentUser;
    if (loginBtn) loginBtn.disabled = false;
  }

  async function apiFetch(path, options = {}, retry = true) {
    const headers = new Headers(options.headers || {});
    if (!(options.body instanceof FormData) && !headers.has('Content-Type') && options.body) {
      headers.set('Content-Type', 'application/json');
    }
    if (accessToken) {
      headers.set('Authorization', `Bearer ${accessToken}`);
    }
    const res = await fetch(path, { ...options, headers, credentials: 'include' });
    if (res.status === 401 && retry) {
      const refreshed = await refreshAccessToken();
      if (refreshed) {
        return apiFetch(path, options, false);
      }
    }
    return res;
  }

  async function refreshAccessToken() {
    try {
      const res = await fetch('/api/auth/refresh', { method: 'POST', credentials: 'include' });
      if (!res.ok) return false;
      const data = await res.json();
      if (data.accessToken) {
        setAccessToken(data.accessToken);
        currentUser = data.user || null;
        updateAuthUi();
        return true;
      }
      return false;
    } catch (e) {
      return false;
    }
  }

  async function login() {
    const emailInput = document.getElementById('emailInput');
    const email = emailInput && emailInput.value ? emailInput.value.trim() : '';
    const res = await fetch('/api/auth/demo-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
      credentials: 'include'
    });
    if (!res.ok) {
      alert('Login failed');
      return;
    }
    const data = await res.json();
    setAccessToken(data.accessToken || '');
    currentUser = data.user || null;
    updateAuthUi();
    await loadDrafts();
    await loadTransactions();
    await getSummary();
  }

  async function logout() {
    await apiFetch('/api/auth/logout', { method: 'POST' }, false);
    currentUser = null;
    setAccessToken('');
    updateAuthUi();
    document.getElementById('transactions').textContent = '';
    document.getElementById('summary').textContent = '';
    document.getElementById('transactionsTable').querySelector('tbody').innerHTML = '';
    draftList = [];
    currentDraft = null;
    draftEditItems = [];
    draftEditTitle = '';
    renderDraftsList();
    renderDraftDetails();
  }

  function ensureLoggedIn() {
    if (!accessToken) {
      alert(t('msg_login_required'));
      return false;
    }
    return true;
  }

  function renderWarningsAndQuestions(data) {
    const warningsBlock = document.getElementById('parseWarningsBlock');
    const warningsList = document.getElementById('parseWarningsList');
    const questionsBlock = document.getElementById('parseQuestionsBlock');
    const questionsList = document.getElementById('parseQuestionsList');
    const warnings = Array.isArray(data?.warnings) ? data.warnings : [];
    const questions = Array.isArray(data?.questions) ? data.questions : [];

    if (warningsBlock && warningsList) {
      warningsBlock.style.display = warnings.length ? 'block' : 'none';
      warningsList.innerHTML = warnings.map((w) => `<li>${w}</li>`).join('');
    }
    if (questionsBlock && questionsList) {
      questionsBlock.style.display = questions.length ? 'block' : 'none';
      questionsList.innerHTML = questions.map((q) => `<li>${q}</li>`).join('');
    }
  }

  async function parseText() {
    if (!ensureLoggedIn()) return;
    const textInput = document.getElementById('text');
    const text = textInput ? textInput.value : '';
    const res = await apiFetch('/api/finance/parse-text', {
      method: 'POST',
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    lastParse = data;
    lastParseSource = 'ai-text';
    renderWarningsAndQuestions(data);
    updateDraftButton('btn_create_draft', false);
    const target = document.getElementById('parseResult');
    if (target) {
      target.textContent = JSON.stringify(data, null, 2);
    }
  }

  async function parseVoice() {
    if (!ensureLoggedIn()) return;
    const fileInput = document.getElementById('voiceFile');
    if (!fileInput || !(fileInput instanceof HTMLInputElement) || !fileInput.files || fileInput.files.length === 0) {
      alert(t('msg_select_file_first'));
      return;
    }
    const file = fileInput.files[0];
    const form = new FormData();
    form.append('file', file);
    const res = await apiFetch('/api/finance/voice', {
      method: 'POST',
      body: form,
      headers: {}
    });
    const data = await res.json();
    lastParse = data;
    lastParseSource = 'ai-voice';
    renderWarningsAndQuestions(data);
    updateDraftButton('btn_create_draft', false);
    const target = document.getElementById('voiceResult');
    if (target) {
      target.textContent = JSON.stringify(data, null, 2);
    }
  }

  function updateDraftButton(labelKey, disabled) {
    const btn = document.getElementById('saveParsedBtn');
    if (btn) {
      btn.disabled = disabled;
      btn.textContent = t(labelKey);
    }
  }

  function buildDraftTitle(source) {
    const dateStr = new Date().toISOString().slice(0, 10);
    const sourceLabel =
      source === 'ai-voice' ? t('draft_source_voice') : source === 'ai-text' ? t('draft_source_text') : t('draft_source_manual');
    return `${t('draft_title_prefix')} ${dateStr} (${sourceLabel})`;
  }

  function normalizeDraftItemsPayload(items, fallbackSource) {
    return (items || []).map((t) => ({
      date: t.date,
      amount: Number(t.amount),
      currency: (t.currency || 'UAH').trim(),
      category: t.category,
      description: t.description || '',
      source: t.source || fallbackSource,
      type: t.type || 'expense'
    }));
  }

  async function createDraftFromParsed() {
    if (!ensureLoggedIn()) return;
    if (!lastParse || !Array.isArray(lastParse.transactions) || lastParse.transactions.length === 0) {
      alert(t('msg_parse_text_first'));
      return;
    }

    const fallbackSource = lastParseSource === 'ai-voice' ? 'voice' : 'manual';
    const items = normalizeDraftItemsPayload(lastParse.transactions, fallbackSource);
    const payload = {
      source: lastParseSource,
      lang: currentUiLang,
      title: buildDraftTitle(lastParseSource),
      items
    };

    const res = await apiFetch('/api/finance/drafts', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data?.error || t('msg_failed_create_draft'));
      return;
    }

    lastDraftId = data.draftId;
    updateDraftButton('btn_draft_created', true);
    await loadDrafts(true, data.draftId);
    if (data.draftId) {
      await openDraft(data.draftId);
    }
  }

  function formatDraftStatus(status) {
    if (status === 'applied') return t('draft_status_applied');
    if (status === 'discarded') return t('draft_status_discarded');
    return t('draft_status_draft');
  }

  function renderDraftsList() {
    const container = document.getElementById('draftsList');
    if (!container) return;
    const items = Array.isArray(draftList) ? draftList : [];
    container.innerHTML = '';
    if (!items.length) {
      container.textContent = t('msg_no_drafts');
      return;
    }

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['col_title', 'col_status', 'col_items', 'col_created', 'col_actions'].forEach((key) => {
      const th = document.createElement('th');
      th.textContent = t(key);
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    items.forEach((draft) => {
      const row = document.createElement('tr');
      const createdAt = draft.createdAt ? new Date(draft.createdAt) : null;
      const createdLabel = createdAt && !isNaN(createdAt.getTime()) ? createdAt.toISOString().slice(0, 19).replace('T', ' ') : '';
      const cells = [
        draft.title || t('msg_no_title'),
        formatDraftStatus(draft.status),
        String(draft.itemsCount || 0),
        createdLabel
      ];
      cells.forEach((value) => {
        const td = document.createElement('td');
        td.textContent = value;
        row.appendChild(td);
      });

      const actionsTd = document.createElement('td');
      const openBtn = document.createElement('button');
      openBtn.type = 'button';
      openBtn.textContent = t('btn_open');
      openBtn.onclick = () => openDraft(draft.id);

      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.style.marginLeft = '4px';
      applyBtn.textContent = t('btn_apply_draft');
      applyBtn.onclick = () => applyDraftById(draft.id);

      const discardBtn = document.createElement('button');
      discardBtn.type = 'button';
      discardBtn.style.marginLeft = '4px';
      discardBtn.textContent = t('btn_discard_draft');
      discardBtn.onclick = () => discardDraftById(draft.id);

      actionsTd.appendChild(openBtn);
      actionsTd.appendChild(applyBtn);
      actionsTd.appendChild(discardBtn);
      row.appendChild(actionsTd);
      tbody.appendChild(row);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function renderDraftDetails() {
    const container = document.getElementById('draftDetails');
    if (!container) return;
    container.innerHTML = '';

    if (!currentDraft) {
      container.innerHTML = `<div class="muted">${t('msg_select_draft')}</div>`;
      return;
    }

    const wrapper = document.createElement('div');
    const editable = currentDraft.status === 'draft';

    const titleLabel = document.createElement('label');
    titleLabel.textContent = t('label_draft_title');
    const titleInput = document.createElement('input');
    titleInput.value = draftEditTitle;
    titleInput.disabled = !editable;
    titleInput.oninput = (e) => {
      draftEditTitle = e.target.value;
    };

    const statusLabel = document.createElement('div');
    statusLabel.className = 'muted';
    statusLabel.textContent = `${t('label_draft_status')} ${formatDraftStatus(currentDraft.status)}`;

    const itemsTable = document.createElement('table');
    itemsTable.id = 'draftItemsTable';
    const headRow = document.createElement('tr');
    ['col_date', 'col_category', 'col_type', 'col_amount', 'col_currency', 'col_description', 'col_source'].forEach((key) => {
      const th = document.createElement('th');
      th.textContent = t(key);
      headRow.appendChild(th);
    });
    const head = document.createElement('thead');
    head.appendChild(headRow);
    itemsTable.appendChild(head);

    const body = document.createElement('tbody');
    if (!draftEditItems.length) {
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 7;
      cell.textContent = t('msg_no_items');
      row.appendChild(cell);
      body.appendChild(row);
    } else {
      draftEditItems.forEach((item, index) => {
        const row = document.createElement('tr');

        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.value = item.date ? item.date.slice(0, 10) : '';
        dateInput.disabled = !editable;
        dateInput.onchange = (e) => updateDraftEditItem(index, 'date', e.target.value);

        const categorySelect = document.createElement('select');
        categorySelect.disabled = !editable;
        categoriesMeta.forEach((cat) => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.label;
          categorySelect.appendChild(opt);
        });
        categorySelect.value = item.category;
        categorySelect.onchange = (e) => updateDraftEditItem(index, 'category', e.target.value);

        const typeSelect = document.createElement('select');
        typeSelect.disabled = !editable;
        ['expense', 'income'].forEach((tVal) => {
          const opt = document.createElement('option');
          opt.value = tVal;
          opt.textContent = formatTxTypeLabel(tVal);
          typeSelect.appendChild(opt);
        });
        typeSelect.value = item.type || 'expense';
        typeSelect.onchange = (e) => updateDraftEditItem(index, 'type', e.target.value);

        const amountInput = document.createElement('input');
        amountInput.type = 'number';
        amountInput.step = '0.01';
        amountInput.min = '0';
        amountInput.value = item.amount;
        amountInput.disabled = !editable;
        amountInput.onchange = (e) => updateDraftEditItem(index, 'amount', Number(e.target.value));

        const currencyInput = document.createElement('input');
        currencyInput.value = item.currency || '';
        currencyInput.disabled = !editable;
        currencyInput.onchange = (e) => updateDraftEditItem(index, 'currency', e.target.value);

        const descriptionInput = document.createElement('input');
        descriptionInput.value = item.description || '';
        descriptionInput.disabled = !editable;
        descriptionInput.onchange = (e) => updateDraftEditItem(index, 'description', e.target.value);

        const sourceInput = document.createElement('input');
        sourceInput.value = item.source || '';
        sourceInput.disabled = !editable;
        sourceInput.onchange = (e) => updateDraftEditItem(index, 'source', e.target.value);

        [
          dateInput,
          categorySelect,
          typeSelect,
          amountInput,
          currencyInput,
          descriptionInput,
          sourceInput
        ].forEach((input) => {
          const td = document.createElement('td');
          td.appendChild(input);
          row.appendChild(td);
        });

        body.appendChild(row);
      });
    }

    itemsTable.appendChild(body);

    const actions = document.createElement('div');
    actions.className = 'inline';

    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.textContent = t('btn_save_draft');
    saveBtn.disabled = !editable;
    saveBtn.onclick = () => saveDraftChanges();

    const applyBtn = document.createElement('button');
    applyBtn.type = 'button';
    applyBtn.textContent = t('btn_apply_draft');
    applyBtn.onclick = () => applyDraftById(currentDraft.id);

    const discardBtn = document.createElement('button');
    discardBtn.type = 'button';
    discardBtn.textContent = t('btn_discard_draft');
    discardBtn.onclick = () => discardDraftById(currentDraft.id);

    actions.appendChild(saveBtn);
    actions.appendChild(applyBtn);
    actions.appendChild(discardBtn);

    wrapper.appendChild(titleLabel);
    wrapper.appendChild(titleInput);
    wrapper.appendChild(statusLabel);
    wrapper.appendChild(itemsTable);
    wrapper.appendChild(actions);
    container.appendChild(wrapper);
  }

  function updateDraftEditItem(index, field, value) {
    if (!draftEditItems[index]) return;
    draftEditItems[index] = { ...draftEditItems[index], [field]: value };
  }

  async function loadDrafts(openLatest = false, focusId = '') {
    if (!ensureLoggedIn()) return;
    const res = await apiFetch('/api/finance/drafts');
    const data = await res.json();
    if (!res.ok) {
      alert(data?.error || t('msg_failed_load_drafts'));
      return;
    }
    draftList = Array.isArray(data?.items) ? data.items : [];
    renderDraftsList();

    const targetId = focusId || (openLatest && draftList.length ? draftList[0].id : '');
    if (targetId) {
      await openDraft(targetId);
    }
  }

  async function openDraft(id) {
    if (!ensureLoggedIn()) return;
    if (!id) return;
    const res = await apiFetch('/api/finance/drafts/' + encodeURIComponent(id));
    const data = await res.json();
    if (!res.ok) {
      alert(data?.error || t('msg_failed_load_drafts'));
      return;
    }
    currentDraft = data.draft;
    draftEditItems = Array.isArray(currentDraft?.items) ? currentDraft.items.map((i) => ({ ...i })) : [];
    draftEditTitle = currentDraft?.title || '';
    renderDraftDetails();
  }

  async function saveDraftChanges() {
    if (!ensureLoggedIn() || !currentDraft) return;
    const fallbackSource = currentDraft.source || 'manual';
    const items = normalizeDraftItemsPayload(draftEditItems, fallbackSource);
    const res = await apiFetch('/api/finance/drafts/' + encodeURIComponent(currentDraft.id), {
      method: 'PATCH',
      body: JSON.stringify({ title: draftEditTitle, items })
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data?.error || t('msg_failed_save_draft'));
      return;
    }
    currentDraft = data.draft;
    draftEditItems = Array.isArray(currentDraft?.items) ? currentDraft.items.map((i) => ({ ...i })) : [];
    draftEditTitle = currentDraft?.title || '';
    await loadDrafts(false, currentDraft.id);
    renderDraftDetails();
    alert(t('msg_draft_saved'));
  }

  async function applyDraftById(id) {
    if (!ensureLoggedIn()) return;
    const res = await apiFetch('/api/finance/drafts/' + encodeURIComponent(id) + '/apply', { method: 'POST' });
    const data = await res.json();
    if (!res.ok) {
      alert(data?.error || t('msg_failed_apply_draft'));
      return;
    }
    await loadDrafts();
    if (currentDraft && currentDraft.id === id) {
      currentDraft = { ...currentDraft, status: 'applied' };
      renderDraftDetails();
    }
    await loadTransactions();
    await getSummary();
    alert(data.duplicate ? t('msg_apply_duplicate') : t('msg_draft_applied'));
  }

  async function discardDraftById(id) {
    if (!ensureLoggedIn()) return;
    const res = await apiFetch('/api/finance/drafts/' + encodeURIComponent(id) + '/discard', { method: 'POST' });
    const data = await res.json();
    if (!res.ok) {
      alert(data?.error || t('msg_failed_discard_draft'));
      return;
    }
    await loadDrafts();
    if (currentDraft && currentDraft.id === id) {
      currentDraft = { ...currentDraft, status: 'discarded' };
      renderDraftDetails();
    }
    alert(t('msg_draft_discarded'));
  }

  function formatTxTypeLabel(type) {
    if (type === 'income') return t('tx_type_income');
    if (type === 'expense') return t('tx_type_expense');
    return t('tx_type_all');
  }

  function updateTransactionsFilterInfo() {
    const info = document.getElementById('txFiltersInfo');
    if (!info) return;
    const parts = [];
    if (activeTxFilters.category) parts.push(`${t('filter_category')}: ${getCategoryLabelForUi(activeTxFilters.category)}`);
    if (activeTxFilters.type && activeTxFilters.type !== 'all') parts.push(`${t('filter_type')}: ${formatTxTypeLabel(activeTxFilters.type)}`);
    if (activeTxFilters.from) parts.push(`${t('filter_from')}: ${activeTxFilters.from}`);
    if (activeTxFilters.to) parts.push(`${t('filter_to')}: ${activeTxFilters.to}`);
    info.textContent = `${t('label_active_filters')} ${parts.length ? parts.join(', ') : t('filters_none')}`;
  }

  function updateCategoryFilterOptions() {
    const select = document.getElementById('txCategoryFilter');
    if (!select) return;
    const previous = select.value || activeTxFilters.category || '';
    select.innerHTML = '';
    const baseOption = document.createElement('option');
    baseOption.value = '';
    baseOption.setAttribute('data-i18n', 'tx_category_all');
    baseOption.textContent = t('tx_category_all');
    select.appendChild(baseOption);
    categoriesMeta.forEach((cat) => {
      const opt = document.createElement('option');
      opt.value = cat.id;
      opt.textContent = cat.label;
      select.appendChild(opt);
    });
    select.value = previous;
  }

  function applyCategoryFilterFromSelect() {
    const select = document.getElementById('txCategoryFilter');
    activeTxFilters.category = select ? (select.value || '') : '';
    updateTransactionsFilterInfo();
  }

  function applyTypeFilterFromSelect() {
    const select = document.getElementById('txTypeFilter');
    activeTxFilters.type = select ? select.value || 'all' : 'all';
    updateTransactionsFilterInfo();
  }

  const categorySelect = document.getElementById('txCategoryFilter');
  if (categorySelect) {
    categorySelect.addEventListener('change', () => {
      applyCategoryFilterFromSelect();
      loadTransactions();
    });
  }

  const typeSelect = document.getElementById('txTypeFilter');
  if (typeSelect) {
    typeSelect.addEventListener('change', () => {
      applyTypeFilterFromSelect();
      loadTransactions();
      getSummary();
    });
  }

  async function loadTransactions() {
    if (!ensureLoggedIn()) return;
    const limitInput = document.getElementById('txLimit');
    const limit = limitInput && limitInput.value ? Number(limitInput.value) : 50;
    activeTxFilters.limit = Number.isFinite(limit) ? Math.max(1, Math.min(limit, 200)) : 50;
    applyCategoryFilterFromSelect();
    applyTypeFilterFromSelect();

    const params = new URLSearchParams({
      page: String(activeTxFilters.page || 1),
      limit: String(activeTxFilters.limit)
    });
    if (activeTxFilters.from) params.append('from', activeTxFilters.from);
    if (activeTxFilters.to) params.append('to', activeTxFilters.to);
    if (activeTxFilters.category) params.append('category', activeTxFilters.category);
    if (activeTxFilters.type && activeTxFilters.type !== 'all') params.append('type', activeTxFilters.type);

    const res = await apiFetch('/api/finance/transactions?' + params.toString());
    const data = await res.json();
    const target = document.getElementById('transactions');
    if (target) {
      target.textContent = JSON.stringify(data, null, 2);
    }

    const items = Array.isArray(data.items) ? data.items : [];
    lastLoadedTransactions = items.slice();
    updateCategoryFilterOptions();
    renderTransactionsTable(items);
    updateTransactionsFilterInfo();
  }

  async function exportTransactionsCsv() {
    if (!ensureLoggedIn()) return;
    const fromInput = document.getElementById('summaryFrom');
    const toInput = document.getElementById('summaryTo');
    const from = activeTxFilters.from || (fromInput && fromInput.value ? fromInput.value : '');
    const to = activeTxFilters.to || (toInput && toInput.value ? toInput.value : '');

    applyTypeFilterFromSelect();

    if (!from || !to) {
      alert(t('msg_export_period_required'));
      return;
    }

    activeTxFilters.from = from;
    activeTxFilters.to = to;

    const params = new URLSearchParams({ from, to, lang: currentUiLang || 'ru' });
    if (activeTxFilters.category) params.append('category', activeTxFilters.category);
    if (activeTxFilters.type && activeTxFilters.type !== 'all') params.append('type', activeTxFilters.type);

    const res = await apiFetch('/api/finance/transactions/export?' + params.toString(), { method: 'GET' });
    if (!res.ok) {
      try {
        const error = await res.json();
        alert((error && error.error) || t('msg_export_failed'));
      } catch (e) {
        alert(t('msg_export_failed'));
      }
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `transactions_${from}_${to}.csv`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
  }

  function renderTransactionsTable(items) {
    const table = document.getElementById('transactionsTable');
    const tbody = document.querySelector('#transactionsTable tbody');
    if (!table || !tbody) return;
    tbody.innerHTML = '';
    const rows = Array.isArray(items) ? items : [];

    if (!rows.length) {
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 8;
      cell.textContent = t('msg_no_transactions');
      row.appendChild(cell);
      tbody.appendChild(row);
      return;
    }

    rows.forEach((item) => {
      const row = document.createElement('tr');
      const date = new Date(item.date);
      const dateStr = isNaN(date.getTime()) ? (item.date || '') : date.toISOString().slice(0, 10);
      const cells = [
        dateStr,
        getCategoryLabelForUi(item.category),
        formatTxTypeLabel(item.type || 'all'),
        String(item.amount ?? ''),
        item.currency || '',
        item.description || '',
        item.source || ''
      ];
      cells.forEach((value) => {
        const td = document.createElement('td');
        td.textContent = value;
        row.appendChild(td);
      });

      const actionsTd = document.createElement('td');
      actionsTd.style.whiteSpace = 'nowrap';
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.textContent = t('btn_edit');
      editBtn.onclick = () => editTransaction(item.id);
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = t('btn_delete');
      deleteBtn.style.marginLeft = '4px';
      deleteBtn.onclick = () => deleteTransaction(item.id);
      actionsTd.appendChild(editBtn);
      actionsTd.appendChild(deleteBtn);
      row.appendChild(actionsTd);
      tbody.appendChild(row);
    });
  }

  function findTransactionById(id) {
    return (lastLoadedTransactions || []).find((tx) => tx.id === id);
  }

  async function deleteTransaction(id) {
    if (!ensureLoggedIn()) return;
    if (!id) return;
    if (!confirm(t('confirm_delete'))) return;
    try {
      const res = await apiFetch('/api/finance/transactions/' + encodeURIComponent(id), { method: 'DELETE' });
      if (res.status === 204) {
        await loadTransactions();
        await getSummary();
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function editTransaction(id) {
    if (!ensureLoggedIn()) return;
    const tx = findTransactionById(id);
    if (!tx) return;
    const newAmountStr = prompt(t('prompt_edit_amount'), tx.amount);
    if (newAmountStr === null) return;
    const newAmount = Number(newAmountStr);
    if (!Number.isFinite(newAmount) || newAmount <= 0) {
      alert(t('msg_invalid_amount'));
      return;
    }
    const categoryLabel = getCategoryLabelForUi(tx.category);
    const newCategoryInput = prompt(t('prompt_edit_category'), categoryLabel) || categoryLabel;
    const newCategory = getCategoryIdByLabel(newCategoryInput) || tx.category;
    const newDescription = prompt(t('prompt_edit_description'), tx.description || '') || tx.description;

    const res = await apiFetch('/api/finance/transactions/' + encodeURIComponent(id), {
      method: 'PATCH',
      body: JSON.stringify({ amount: newAmount, category: newCategory, description: newDescription })
    });
    const data = await res.json();
    if (data?.item) {
      await loadTransactions();
      await getSummary();
    }
  }

  async function getSummary() {
    if (!ensureLoggedIn()) return;
    const fromInput = document.getElementById('summaryFrom');
    const toInput = document.getElementById('summaryTo');
    const from = fromInput ? fromInput.value : '';
    const to = toInput ? toInput.value : '';
    applyTypeFilterFromSelect();
    if (!from || !to) {
      alert('from/to are required');
      return;
    }
    const params = new URLSearchParams({ from, to, groupBy: 'both' });
    if (activeTxFilters.type && activeTxFilters.type !== 'all') params.append('type', activeTxFilters.type);
    const res = await apiFetch('/api/finance/summary?' + params.toString());
    const data = await res.json();
    const target = document.getElementById('summary');
    if (target) {
      target.textContent = JSON.stringify(data, null, 2);
    }
    lastSummaryData = data;
    renderSummaryTotals(data);
    renderSummaryTables(data);
    activeTxFilters.from = from;
    activeTxFilters.to = to;
    updateTransactionsFilterInfo();
  }

  function renderSummaryTables(data) {
    const byCatBody = document.querySelector('#summaryByCategory tbody');
    const byDateBody = document.querySelector('#summaryByDate tbody');
    if (byCatBody) {
      byCatBody.innerHTML = '';
      if (Array.isArray(data.byCategory) && data.byCategory.length) {
        data.byCategory.forEach((row) => {
          const tr = document.createElement('tr');
          tr.classList.add('drill-row');
          tr.dataset.category = String(row.category);
          const tdCat = document.createElement('td');
          tdCat.textContent = getCategoryLabelForUi(row.category);
          const tdAmount = document.createElement('td');
          tdAmount.textContent = String(row.amount ?? '');
          tr.appendChild(tdCat);
          tr.appendChild(tdAmount);
          tr.addEventListener('click', () => {
            const select = document.getElementById('txCategoryFilter');
            if (select) {
              select.value = row.category || '';
            }
            activeTxFilters.category = row.category || '';
            updateTransactionsFilterInfo();
            loadTransactions();
          });
          byCatBody.appendChild(tr);
        });
      } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 2;
        td.textContent = t('msg_no_data');
        tr.appendChild(td);
        byCatBody.appendChild(tr);
      }
    }

    if (byDateBody) {
      byDateBody.innerHTML = '';
      if (Array.isArray(data.byDate) && data.byDate.length) {
        data.byDate.forEach((row) => {
          const tr = document.createElement('tr');
          tr.classList.add('drill-row');
          tr.dataset.date = String(row.date);
          const tdDate = document.createElement('td');
          tdDate.textContent = row.date || '';
          const tdAmount = document.createElement('td');
          tdAmount.textContent = String(row.amount ?? '');
          tr.appendChild(tdDate);
          tr.appendChild(tdAmount);
          tr.addEventListener('click', () => {
            activeTxFilters.from = row.date;
            activeTxFilters.to = row.date;
            const select = document.getElementById('txCategoryFilter');
            if (select) {
              select.value = '';
            }
            activeTxFilters.category = '';
            loadTransactions();
          });
          byDateBody.appendChild(tr);
        });
      } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 2;
        td.textContent = t('msg_no_data');
        tr.appendChild(td);
        byDateBody.appendChild(tr);
      }
    }
  }

  function renderSummaryTotals(data) {
    const container = document.getElementById('summaryTotals');
    if (!container) return;
    container.innerHTML = '';
    if (!data) return;

    const income = typeof data.incomeTotal === 'number' ? data.incomeTotal : 0;
    const expense = typeof data.expenseTotal === 'number' ? data.expenseTotal : 0;
    const balance = typeof data.balance === 'number' ? data.balance : income - expense;

    const items = [
      { label: t('summary_income'), value: income },
      { label: t('summary_expense'), value: expense },
      { label: t('summary_balance'), value: balance }
    ];

    items.forEach((item) => {
      const span = document.createElement('span');
      span.textContent = `${item.label}: ${item.value}`;
      container.appendChild(span);
    });
  }

  async function askAssistant() {
    if (!ensureLoggedIn()) return;
    const msgInput = document.getElementById('assistantMsg');
    const message = msgInput ? msgInput.value : '';
    const res = await apiFetch('/api/finance/assistant', {
      method: 'POST',
      body: JSON.stringify({ message })
    });
    const data = await res.json();
    const target = document.getElementById('assistant');
    if (target) {
      target.textContent = JSON.stringify(data, null, 2);
    }
    const human = document.getElementById('assistantHuman');
    if (human) {
      const answer = data && typeof data.answer === 'string' ? data.answer : '';
      human.textContent = answer || '';
    }
  }

  function toIsoDate(d) {
    return d.toISOString().slice(0, 10);
  }

  function setSummaryRange(rangeKey) {
    const fromInput = document.getElementById('summaryFrom');
    const toInput = document.getElementById('summaryTo');
    if (!fromInput || !toInput) return;
    const today = new Date();
    let from = new Date(today);
    let to = new Date(today);
    if (rangeKey === 'week') {
      const day = today.getDay();
      const diffToMonday = (day + 6) % 7;
      from.setDate(today.getDate() - diffToMonday);
    } else if (rangeKey === 'month') {
      from = new Date(today.getFullYear(), today.getMonth(), 1);
      to = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    }
    fromInput.value = toIsoDate(from);
    toInput.value = toIsoDate(to);
    activeTxFilters.from = fromInput.value;
    activeTxFilters.to = toInput.value;
    getSummary();
  }

  const EXAMPLE_QUESTIONS = {
    ru: [
      'Сколько потратил на еду в этом месяце?',
      'Сколько всего я потратил сегодня?',
      'Какая категория трат самая большая за последнюю неделю?'
    ],
    uk: [
      'Скільки я витратив на їжу цього місяця?',
      'Скільки всього я витратив сьогодні?',
      'Яка категорія витрат була найбільшою за останній тиждень?'
    ],
    en: [
      'How much did I spend on food this month?',
      'How much did I spend in total today?',
      'Which spending category was the biggest in the last week?'
    ]
  };

  function renderAssistantExamples() {
    const container = document.getElementById('assistantExamples');
    if (!container) return;
    const select = document.getElementById('uiLangSelect');
    const lang = (select && select.value) || currentUiLang || 'ru';
    const examples = EXAMPLE_QUESTIONS[lang] || EXAMPLE_QUESTIONS.ru;
    container.innerHTML = '';
    const label = document.createElement('div');
    label.className = 'quick-examples-label';
    label.textContent = 'Примеры:';
    container.appendChild(label);
    const buttons = document.createElement('div');
    buttons.className = 'quick-examples-buttons';
    examples.forEach((ex) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = ex;
      btn.onclick = () => {
        const msgInput = document.getElementById('assistantMsg');
        if (msgInput) msgInput.value = ex;
      };
      buttons.appendChild(btn);
    });
    container.appendChild(buttons);
  }

  async function bootstrap() {
    applyUiLang();
    renderAssistantExamples();
    renderDraftsList();
    renderDraftDetails();
    updateDraftButton('btn_create_draft', true);
    await loadCategoriesForLang(currentUiLang);
    if (accessToken) {
      await refreshAccessToken();
    }
    updateAuthUi();
  }

  bootstrap();
</script>
</body>
</html>
