<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>AI Financial Assistant Demo</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      section { margin-bottom: 24px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
      label { display: block; margin: 6px 0 2px; }
      textarea, input, select { width: 100%; padding: 6px; }
      button { margin-top: 8px; padding: 8px 12px; }
      pre { background: #f5f5f5; padding: 8px; overflow-x: auto; }
    

table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; }
th { background: #f0f0f0; }
.muted { color: #666; font-size: 12px; }
#summaryTables {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
  margin-top: 8px;
}
</style>
  </head>
  <body>
    <h1>AI Financial Assistant</h1>
    <section>
      <h2>Парсинг текста</h2>
      <label>userId</label>
      <input id="userId" value="demo_user" />
      <label>Текст</label>
      <textarea id="text" rows="3">Сегодня 300 на продукты и 200 на такси</textarea>
      <button onclick="parseText()">Отправить /parse-text</button>
      <pre id="parseResult"></pre>
      <button id="saveParsedBtn" onclick="saveParsed()">Сохранить транзакции</button>
    </section>

    <section>
      <h2>Голосовой ввод (файл)</h2>
      <p class="muted">Шаг 1: выберите аудиофайл (webm/wav/m4a и т.п.), шаг 2: отправьте на /voice, затем при желании сохраните транзакции общей кнопкой ниже.</p>
      <label>Аудиофайл</label>
      <input id="voiceFile" type="file" accept="audio/*" />
      <button onclick="parseVoice()">Отправить /voice</button>
      <pre id="voiceResult"></pre>
    </section>

    <section>
      <h2>Транзакции</h2>
      <button onclick="loadTransactions()">Загрузить /transactions</button>
      
<pre id="transactions"></pre>
<div class="muted">Таблица для быстрого просмотра:</div>
<table id="transactionsTable">
  <thead>
    <tr>
      <th>Дата</th>
      <th>Категория</th>
      <th>Сумма</th>
      <th>Валюта</th>
      <th>Описание</th>
      <th>Источник</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
    </section>

    <section>
      <h2>Сводка</h2>
      <label>From</label>
      <input id="summaryFrom" placeholder="2025-12-01" />
      <label>To</label>
      <input id="summaryTo" placeholder="2025-12-31" />
      <button onclick="getSummary()">Получить summary</button>
      
<pre id="summary"></pre>
<div class="muted">Сводка по категориям и датам:</div>
<div id="summaryTables">
  <table id="summaryByCategory">
    <thead>
      <tr>
        <th>Категория</th>
        <th>Сумма</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <table id="summaryByDate">
    <thead>
      <tr>
        <th>Дата</th>
        <th>Сумма</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
    </section>

    <section>
      <h2>Вопрос ассистенту</h2>
      <label>Сообщение</label>
      <textarea id="assistantMsg" rows="2">Сколько потратил на еду в этом месяце?</textarea>
      <button onclick="askAssistant()">Спросить</button>
      <pre id="assistant"></pre>
    </section>

    <script>
      let lastParse;
      let lastSavedKey = null;

      // lastSavedKey хранит fingerprint последнего успешно сохранённого набора транзакций для защиты от дублей.
      // Он сбрасывается при новом parseText().

      async function parseText() {
        const userIdInput = document.getElementById('userId');
        const textInput = document.getElementById('text');
        const userId = userIdInput ? userIdInput.value : '';
        const text = textInput ? textInput.value : '';
        const res = await fetch('/api/finance/parse-text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, text })
        });
        const data = await res.json();
        lastParse = data;
        lastSavedKey = null;
        const btn = document.getElementById('saveParsedBtn');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Сохранить транзакции';
        }
        const target = document.getElementById('parseResult');
        if (target) {
          target.textContent = JSON.stringify(data, null, 2);
        }
      

            }

async function parseVoice() {
        const userIdInput = document.getElementById('userId');
        const fileInput = document.getElementById('voiceFile');
        const userId = userIdInput ? userIdInput.value : '';
        if (!fileInput || !(fileInput instanceof HTMLInputElement) || !fileInput.files || fileInput.files.length === 0) {
          alert('Сначала выберите аудиофайл.');
          return;
        }
        const file = fileInput.files[0];
        const form = new FormData();
        if (userId) {
          form.append('userId', userId);
        }
        form.append('file', file);

        const res = await fetch('/api/finance/voice', {
          method: 'POST',
          body: form
        });
        const data = await res.json();
        lastParse = data;
        lastSavedKey = null;
        const btn = document.getElementById('saveParsedBtn');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Сохранить транзакции';
        }
        const target = document.getElementById('voiceResult');
        if (target) {
          target.textContent = JSON.stringify(data, null, 2);
        }
      }

      async function saveParsed() {
        if (!lastParse || !Array.isArray(lastParse.transactions)) {
          alert('Сначала распарсьте текст');
          return;
        }
        const fingerprint = JSON.stringify({ userId: lastParse.userId, tx: lastParse.transactions });
        if (lastSavedKey === fingerprint) {
          alert('Эти транзакции уже сохранены');
          return;
        }
        const items = lastParse.transactions.map(t => ({
          ...t,
          userId: lastParse.userId
        }));
        const res = await fetch('/api/finance/transactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });
        const data = await res.json();
        lastSavedKey = fingerprint;
        const btn = document.getElementById('saveParsedBtn');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Сохранено';
        }
        const target = document.getElementById('transactions');
        if (target) {
          target.textContent = JSON.stringify(data, null, 2);
        }
        const list = Array.isArray(data.items) ? data.items : items;
        renderTransactionsTable(list);
      }

      async function loadTransactions() {
        const userIdInput = document.getElementById('userId');
        const userId = userIdInput ? userIdInput.value : '';
        const params = new URLSearchParams({ userId, page: '1', limit: '50' });
        const res = await fetch('/api/finance/transactions?' + params.toString());
        const data = await res.json();
        const target = document.getElementById('transactions');
        if (target) {
          target.textContent = JSON.stringify(data, null, 2);
        }
        renderTransactionsTable(data.items || []);
      }

      function renderTransactionsTable(items) {
        const tbody = document.querySelector('#transactionsTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!items || !items.length) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Транзакций нет';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }
        items.forEach(item => {
          const row = document.createElement('tr');
          const date = new Date(item.date);
          const dateStr = isNaN(date.getTime()) ? (item.date || '') : date.toISOString().slice(0, 10);
          const cells = [
            dateStr,
            item.category || '',
            String(item.amount ?? ''),
            item.currency || '',
            item.description || '',
            item.source || ''
          ];
          cells.forEach(value => {
            const td = document.createElement('td');
            td.textContent = value;
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });
      }

      async function getSummary() {
        const userIdInput = document.getElementById('userId');
        const fromInput = document.getElementById('summaryFrom');
        const toInput = document.getElementById('summaryTo');
        const userId = userIdInput ? userIdInput.value : '';
        const from = fromInput ? fromInput.value : '';
        const to = toInput ? toInput.value : '';
        const params = new URLSearchParams({ userId, from, to, groupBy: 'both' });
        const res = await fetch('/api/finance/summary?' + params.toString());
        const data = await res.json();
        const target = document.getElementById('summary');
        if (target) {
          target.textContent = JSON.stringify(data, null, 2);
        }
        renderSummaryTables(data);
      }

      function renderSummaryTables(data) {
        const byCatBody = document.querySelector('#summaryByCategory tbody');
        const byDateBody = document.querySelector('#summaryByDate tbody');

        if (byCatBody) {
          byCatBody.innerHTML = '';
          if (Array.isArray(data.byCategory) && data.byCategory.length) {
            data.byCategory.forEach(row => {
              const tr = document.createElement('tr');
              const tdCat = document.createElement('td');
              tdCat.textContent = row.category || '(без категории)';
              const tdAmount = document.createElement('td');
              tdAmount.textContent = String(row.amount ?? '');
              tr.appendChild(tdCat);
              tr.appendChild(tdAmount);
              byCatBody.appendChild(tr);
            });
          } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;
            td.textContent = 'Нет данных';
            tr.appendChild(td);
            byCatBody.appendChild(tr);
          }
        }

        if (byDateBody) {
          byDateBody.innerHTML = '';
          if (Array.isArray(data.byDate) && data.byDate.length) {
            data.byDate.forEach(row => {
              const tr = document.createElement('tr');
              const tdDate = document.createElement('td');
              tdDate.textContent = row.date || '';
              const tdAmount = document.createElement('td');
              tdAmount.textContent = String(row.amount ?? '');
              tr.appendChild(tdDate);
              tr.appendChild(tdAmount);
              byDateBody.appendChild(tr);
            });
          } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;
            td.textContent = 'Нет данных';
            tr.appendChild(td);
            byDateBody.appendChild(tr);
          }
        }
      }

      async function askAssistant() {
        const userIdInput = document.getElementById('userId');
        const msgInput = document.getElementById('assistantMsg');
        const userId = userIdInput ? userIdInput.value : '';
        const message = msgInput ? msgInput.value : '';
        const res = await fetch('/api/finance/assistant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, message })
        });
        const data = await res.json();
        const target = document.getElementById('assistant');
        if (target) {
          target.textContent = JSON.stringify(data, null, 2);
        }
      }
    </script>
  </body>
</html>
